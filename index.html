<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Porukka-Vedot</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0b0e14; color: #e1e1e1; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; display: none; }
        
        /* KIRJAUTUMISRUUDUT */
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0e14; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .auth-box { background: #1a1f29; padding: 40px; border-radius: 15px; border: 2px solid #f39c12; text-align: center; width: 90%; max-width: 400px; }
        
        .btn { border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-bottom: 10px; width: 100%; display: block; }
        .btn-google { background: #fff; color: #000; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-bet { background: #f39c12; color: #000; text-transform: uppercase; }
        .btn-secondary { background: #2a303c; color: #fff; border: 1px solid #444; }

        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #0b0e14; color: white; box-sizing: border-box; }

        /* BANNERI & MUUT */
        .banner-container { position: relative; width: 100%; height: 220px; margin-bottom: 30px; border-radius: 15px; overflow: hidden; border: 2px solid #f39c12; }
        .main-banner { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.9); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #1a1f29; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        .stat-value { display: block; font-size: 1.8rem; font-weight: bold; color: #f39c12; }
        
        .leaderboard-section { background: #1a1f29; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #333; }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th { text-align: left; color: #888; font-size: 0.8rem; padding: 10px; }
        .leaderboard-table td { padding: 12px 10px; border-bottom: 1px solid #2a303c; }

        .tournament-section { margin-bottom: 40px; }
        .tournament-header { background: #1e2533; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; border-bottom: 2px solid #f39c12; color: #f39c12; font-weight: bold; }
        .match-card { background: #1a1f29; margin-bottom: 10px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .team img { width: 45px; height: 45px; object-fit: contain; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1a1f29; padding: 30px; border-radius: 15px; border: 2px solid #f39c12; text-align: center; max-width: 450px; width: 90%; }
        .team-select-btn { background: #2a303c; color: white; padding: 20px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; flex: 1; }

        #my-bets-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
        .bet-card { background: #2a303c; padding: 12px; border-radius: 10px; border: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        
        @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } .match-card { flex-direction: column; gap: 15px; } }
    </style>
</head>
<body>

<div id="auth-screen" class="auth-screen">
    <div class="auth-box">
        <h2 style="margin-top:0">CS2 Vedot</h2>
        <button class="btn btn-google" onclick="app.loginGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="18"> Jatka Google-tilill√§
        </button>
        <div style="margin: 15px 0; color: #555;">‚îÄ tai s√§hk√∂postilla ‚îÄ</div>
        <input type="email" id="email-input" placeholder="S√§hk√∂posti">
        <input type="password" id="pass-input" placeholder="Salasana">
        <button class="btn btn-bet" onclick="app.loginEmail()">Kirjaudu</button>
        <button class="btn btn-secondary" onclick="app.registerEmail()">Luo uusi tili</button>
    </div>
</div>

<div id="username-screen" class="auth-screen" style="display:none">
    <div class="auth-box">
        <h3>Valitse k√§ytt√§j√§nimi</h3>
        <p style="font-size: 0.8rem; color: #888;">T√§m√§ nimi n√§kyy Leaderboardilla.</p>
        <input type="text" id="username-input" placeholder="Esim. CS_Mestari_26" maxlength="15">
        <button class="btn btn-bet" onclick="app.saveUsername()">Tallenna ja jatka</button>
    </div>
</div>

<div class="container" id="main-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="color:#f39c12; font-weight:bold;">Tervetuloa, <span id="display-username"></span></div>
        <button onclick="app.logout()" style="background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Kirjaudu ulos</button>
    </div>

    <div class="banner-container">
        <img src="Banner2.png" alt="Banner" class="main-banner" onerror="this.src='https://images.alphacoders.com/133/1331713.png'">
    </div>

    <div class="leaderboard-section">
        <h3 style="margin-top:0; color:#f39c12;">üèÜ Porukan Leaderboard</h3>
        <table class="leaderboard-table">
            <thead><tr><th>Sija</th><th>Pelaaja</th><th>Voitot</th><th>Pisteet</th></tr></thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><span class="stat-value" id="user-points">0.00</span><span class="stat-label">Omat Pisteet</span></div>
        <div class="stat-card"><span class="stat-value" id="user-wins">0</span><span class="stat-label">Omat Voitot</span></div>
        <div class="stat-card"><span class="stat-value" id="user-acc">0%</span><span class="stat-label">Osumat</span></div>
    </div>
    
    <div id="match-container"></div>
    <h2>Omat vedot</h2>
    <div id="my-bets-list"></div>
</div>

<div class="modal-overlay" id="betModal">
    <div class="modal-content">
        <h3>Aseta veto</h3>
        <div class="modal-teams" id="modalTeamsContainer" style="display:flex; gap:10px;"></div>
        <button class="btn" style="background:transparent; color:#888; margin-top:15px;" onclick="app.closeModal()">Peruuta</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCyj2zKkNw8JP_gG0F6AjyHiIr_EUjbFMA",
        authDomain: "cs2-leaderboard.firebaseapp.com",
        projectId: "cs2-leaderboard",
        storageBucket: "cs2-leaderboard.firebasestorage.app",
        messagingSenderId: "596762153722",
        appId: "1:596762153722:web:6d16722d0be705c21baf43"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const provider = new GoogleAuthProvider();

    const PANDASCORE_TOKEN = '-p-nSCX_xPTuzmVICmpPuAx_nxSAmGVE7cXB01x0rbY8zWU1AFA';
    const PROXY = 'https://cors-anywhere.herokuapp.com/';

    window.app = {
        user: null,
        username: null,
        matches: [],

        init: function() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    this.user = user;
                    const profile = await getDoc(doc(db, "profiles", user.uid));
                    if (profile.exists()) {
                        this.username = profile.data().username;
                        this.showMain();
                    } else {
                        this.showUsernameSelection();
                    }
                } else {
                    this.showAuth();
                }
            });
        },

        // AUTH TOIMINNOT
        loginGoogle: () => signInWithPopup(auth, provider).catch(e => alert(e.message)),
        
        registerEmail: () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('pass-input').value;
            createUserWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
        },

        loginEmail: () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('pass-input').value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
        },

        logout: () => signOut(auth),

        saveUsername: async function() {
            const name = document.getElementById('username-input').value.trim();
            if (name.length < 3) return alert("Nimi liian lyhyt!");
            
            await setDoc(doc(db, "profiles", this.user.uid), { username: name });
            await setDoc(doc(db, "users", name), { points: 0, wins: 0, totalBets: 0, uid: this.user.uid });
            this.username = name;
            this.showMain();
        },

        // N√ÑKYM√ÑT
        showAuth: () => {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('username-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
        },
        showUsernameSelection: () => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('username-screen').style.display = 'flex';
        },
        showMain: async function() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('username-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('display-username').innerText = this.username;
            this.listenToLeaderboard();
            await this.getMatches();
            await this.checkResults();
        },

        // PELILOGIIKKA (Samat kuin aiemmin, mutta k√§ytt√§√§ this.username)
        listenToLeaderboard: function() {
            const q = query(collection(db, "users"), orderBy("points", "desc"));
            onSnapshot(q, (snap) => {
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '';
                snap.docs.forEach((doc, i) => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr style="${doc.id===this.username?'color:#f39c12':''}"><td>#${i+1}</td><td>${doc.id}</td><td>${d.wins||0}</td><td>${(d.points||0).toFixed(2)}</td></tr>`;
                    if (doc.id === this.username) {
                        document.getElementById('user-points').innerText = (d.points || 0).toFixed(2);
                        document.getElementById('user-wins').innerText = d.wins || 0;
                        document.getElementById('user-acc').innerText = d.totalBets > 0 ? Math.round((d.wins/d.totalBets)*100)+"%" : "0%";
                    }
                });
            });
        },

        getMatches: async function() {
            const r = await fetch(PROXY + 'https://api.pandascore.co/csgo/matches/upcoming?per_page=50&sort=begin_at', {
                headers: { 'Authorization': `Bearer ${PANDASCORE_TOKEN}` }
            });
            this.matches = await r.json();
            this.renderMatches();
        },

        renderMatches: function() {
            const container = document.getElementById('match-container');
            container.innerHTML = '';
            const grouped = this.matches.reduce((acc, m) => {
                if (!acc[m.league.name]) acc[m.league.name] = [];
                acc[m.league.name].push(m);
                return acc;
            }, {});

            for (const [league, ms] of Object.entries(grouped)) {
                let html = `<div class="tournament-section"><div class="tournament-header">${league}</div>`;
                ms.forEach(m => {
                    const t1 = m.opponents[0]?.opponent || { name: "TBD" };
                    const t2 = m.opponents[1]?.opponent || { name: "TBD" };
                    if (t1.name === "TBD" || t2.name === "TBD") return;
                    const odds = this.calcOdds(t1.name, t2.name, m.id);
                    html += `<div class="match-card"><div class="teams"><div class="team"><span>${t1.name}</span><span class="odds-badge">${odds[0]}</span></div><div style="color:#444">VS</div><div class="team"><span>${t2.name}</span><span class="odds-badge">${odds[1]}</span></div></div><div class="details"><button class="btn btn-bet" style="width:auto" onclick="app.openBetModal('${m.id}')">Veto</button></div></div>`;
                });
                container.innerHTML += html + '</div>';
            }
        },

        calcOdds: (n1, n2, id) => {
            const seed = (parseInt(id.toString().slice(-3)) / 1000) * 0.1 - 0.05;
            return [(0.92/(0.5+seed)).toFixed(2), (0.92/(0.5-seed)).toFixed(2)];
        },

        openBetModal: function(id) {
            const m = this.matches.find(x => x.id == id);
            const t1 = m.opponents[0].opponent, t2 = m.opponents[1].opponent;
            const odds = this.calcOdds(t1.name, t2.name, id);
            document.getElementById('modalTeamsContainer').innerHTML = `
                <div class="team-select-btn" onclick="app.placeBet('${id}', '${t1.name}', ${odds[0]}, '${t1.name} vs ${t2.name}')"><span>${t1.name}</span><strong>x${odds[0]}</strong></div>
                <div class="team-select-btn" onclick="app.placeBet('${id}', '${t2.name}', ${odds[1]}, '${t1.name} vs ${t2.name}')"><span>${t2.name}</span><strong>x${odds[1]}</strong></div>`;
            document.getElementById('betModal').style.display = 'flex';
        },

        placeBet: async function(matchId, team, odds, matchName) {
            await setDoc(doc(db, "users", this.username, "bets", matchId), { team, odds, matchName, result: 'pending' });
            this.closeModal();
            this.checkResults();
        },

        checkResults: async function() {
            const betsSnap = await getDocs(collection(db, "users", this.username, "bets"));
            const r = await fetch(PROXY + 'https://api.pandascore.co/csgo/matches/past?per_page=50', {
                headers: { 'Authorization': `Bearer ${PANDASCORE_TOKEN}` }
            });
            const past = await r.json();
            
            let pts = 0, wins = 0, finished = 0;
            const list = document.getElementById('my-bets-list');
            list.innerHTML = '';

            for (const betDoc of betsSnap.docs) {
                const b = betDoc.data();
                const match = past.find(x => x.id == betDoc.id);
                let currentRes = b.result;

                if (match && match.winner && currentRes === 'pending') {
                    currentRes = (match.winner.name === b.team) ? 'win' : 'loss';
                    await setDoc(doc(db, "users", this.username, "bets", betDoc.id), { result: currentRes }, { merge: true });
                }

                if (currentRes === 'win') { wins++; pts += (10 * b.odds); finished++; }
                else if (currentRes === 'loss') { finished++; }

                list.innerHTML += `<div class="bet-card ${currentRes==='win'?'status-win':currentRes==='loss'?'status-loss':''}"><div><strong>${b.matchName}</strong><br>${b.team} (${b.odds})</div></div>`;
            }
            await setDoc(doc(db, "users", this.username), { points: pts, wins: wins, totalBets: finished }, { merge: true });
        },

        closeModal: () => document.getElementById('betModal').style.display = 'none'
    };

    app.init();
</script>
</body>
</html>